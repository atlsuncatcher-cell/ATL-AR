<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ATL - AR Viewer</title>
  <style>
    :root{--accent:#9d72a6;--bg:#2b2030;--card:#3a2d3d;--muted:#cfc6d1}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,var(--bg),#1f1722);color:#fff;min-height:100vh}
    header{padding:18px 20px;display:flex;gap:12px;align-items:center;border-bottom:1px solid rgba(255,255,255,0.03)}
    .logo{font-weight:700;color:var(--accent)}
    .subtitle{opacity:0.9;font-size:0.95rem}
    main{padding:18px;display:grid;grid-template-columns:320px 1fr;gap:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.4)}
    .controls button{display:block;width:100%;padding:12px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
    .hint{font-size:0.9rem;color:var(--muted);margin-top:10px}
    #preview{width:100%;height:220px;background:#111;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    #preview img{max-width:100%;max-height:100%;object-fit:contain;opacity:0.95}
    footer{padding:12px 20px;text-align:center;color:var(--muted);font-size:0.9rem}
    #ar-root{position:fixed;inset:0;display:none;z-index:50}
    #close-ar{position:absolute;left:12px;top:12px;z-index:60;padding:10px;border-radius:8px;background:rgba(0,0,0,0.6);color:#fff;border:0}
    #message{position:absolute;right:12px;top:12px;z-index:60;padding:10px;border-radius:8px;background:rgba(0,0,0,0.4);color:#fff}
  </style>
</head>
<body>
  <header>
    <div class="logo">ATL - Attract The Light</div>
    <div class="subtitle">AR Wedding Video Viewer</div>
  </header>

  <main>
    <section class="card" aria-labelledby="left-title">
      <h3 id="left-title">Hey Cuties</h3>
      <div id="preview"><img id="sample-img" src="assets/images/IMG_8086.PNG" alt="Preview"></div>
      <div style="height:12px"></div>
      <div class="controls">
   

        <div style="height:14px"></div>
        <button id="deploy-btn">Open AR (test)</button>
        <div class="hint">Use your phone browser on HTTPS (GitHub Pages / Vercel). For local testing use <code>http://localhost</code> via Live Server.</div>
      </div>
    </section>

    <section class="card">
      <h3>Preview & Status</h3>
      <div id="status" style="margin-top:12px;color:var(--muted)">Status: Ready. No AR active.</div>
      <div style="height:12px"></div>

      <h4 style="margin-bottom:6px">Mappings (from config.json)</h4>
      <pre id="mapping-preview" style="background:#241a26;padding:12px;border-radius:8px;color:var(--muted)">Loading mappings...</pre>

      <div style="height:12px"></div>
      <details style="color:var(--muted)"><summary>How it works</summary>
        <p style="margin:8px 0">Upload your images to MindAR generator, download combined <code>targets.mind</code>, add it into <code>targets/</code>, add videos into <code>videos/</code>, then edit <code>config.json</code> mapping indices to filenames. Press "Open AR" on your phone and allow camera.</p>
      </details>
    </section>
  </main>



  <div id="ar-root" role="application" aria-hidden="true">
    <button id="close-ar">Close</button>
    <div id="message">Point camera at print</div>
    <div id="ar-container"></div>
  </div>
  <footer class="card">Built for ATL Â· Dynamic multi-target AR (A-Frame + MindAR)</footer>
  <script>
  async function loadConfig(){
    try{
      const res = await fetch('config.json');
      if(!res.ok) throw new Error('config.json not found');
      const cfg = await res.json();
      document.getElementById('mapping-preview').textContent = JSON.stringify(cfg,null,2);
      return cfg.mappings || [];
    }catch(e){
      document.getElementById('mapping-preview').textContent = 'No config.json found. Use default sample mapping.';
      return [
        { "targetIndex": 0, "video": "videos/video001.mp4" }
      ];
    }
  }

  async function buildARScene(mappings){
    const container = document.getElementById('ar-container');
    container.innerHTML = '';

    // create a-scene with MindAR attributes loaded from CDN
    const scene = document.createElement('a-scene');
    scene.setAttribute('embedded','');
    scene.setAttribute('vr-mode-ui','enabled:false');
    scene.setAttribute('device-orientation-permission-ui','enabled:false');
    scene.setAttribute('mindar-image','imageTargetSrc: ./targets/targets.mind;');

    // assets
    const assets = document.createElement('a-assets');
    assets.setAttribute('id','asset-container');

    mappings.forEach((m,idx) => {
      const v = document.createElement('video');
      v.id = 'v'+idx;
      v.src = m.video;
      v.loop = true;
      v.preload = 'auto';
      v.crossOrigin = 'anonymous';
      v.style.display = 'none';
      assets.appendChild(v);
    });

    scene.appendChild(assets);

    mappings.forEach((m,idx) => {
      const aVideo = document.createElement('a-video');
      aVideo.setAttribute('src', '#v'+idx);
      aVideo.setAttribute('target-index', String(m.targetIndex));
      aVideo.setAttribute('width','1');
      aVideo.setAttribute('height','0.6');
      scene.appendChild(aVideo);
    });

    const cam = document.createElement('a-entity');
    cam.setAttribute('camera','');
    scene.appendChild(cam);

    container.appendChild(scene);
    return scene;
  }

  document.getElementById('deploy-btn').addEventListener('click', async ()=>{
    document.getElementById('status').textContent = 'Status: Initializing...';
    const mappings = await loadConfig();
    document.getElementById('ar-root').style.display = 'block';
    document.getElementById('ar-root').setAttribute('aria-hidden','false');

    const scene = await buildARScene(mappings);

    try{
      await navigator.mediaDevices.getUserMedia({video:true});
    }catch(err){
      alert('Camera permission required. Open this page on your phone and allow camera.');
      return;
    }

    try{
      scene.addEventListener('renderstart', ()=>{ document.getElementById('status').textContent='Status: AR running'; });
      const sceneEl = document.querySelector('a-scene');
      sceneEl.addEventListener('loaded', () => {
        const arSystem = sceneEl.systems['mindar-image-system'];
        arSystem.start();
      });
      document.querySelectorAll('#asset-container video').forEach(v => { v.muted=true; v.play().catch(()=>{}); });
    }catch(e){
      console.error('AR start error',e);
      alert('Could not start AR. Check targets/targets.mind exists and is valid (generated by MindAR image tool).');
      document.getElementById('status').textContent = 'Status: Error starting AR';
    }
  });

  document.getElementById('close-ar').addEventListener('click', () => {
    document.getElementById('ar-root').style.display = 'none';
    document.getElementById('status').textContent = 'Status: Stopped';
    try{
      const scene = document.querySelector('a-scene');
      if(scene && scene.systems && scene.systems['mindar-image-system']) scene.systems['mindar-image-system'].stop();
    }catch(e){}
    document.getElementById('ar-container').innerHTML = '';
  });

  loadConfig();
  </script>

</body>
</html>
